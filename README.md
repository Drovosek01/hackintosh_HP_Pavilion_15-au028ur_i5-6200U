# Что я делал при установки Hackintosh на ноутбук

Эту инструкцию я писал для себя, чтобы после переустановки не вспоминать что и как делать. Инструкция написана после установки macOS Mojave 10.14.5. на ноутбук [HP Pavilion 15-au028ur](https://www.support.hp.com/document/c05193511).

## Характеристики ноутбука HP Pavilion 15-au028ur

* Процессор
  * Intel Core i5-6200U 2.3GHz, Turbobust 2.8GHz, Skylake
* Видеокарта
  * Intel HD Graphics 520
  * Nvidia Geforce 940MX
* ОЗУ
  * DDR4 2133MHz
* Системная плата
  * HP 820C v82.39
* BIOS
  * HP Insyde F.52
* Звуковой адаптер
  * Realtek ALC 295
* Bluetooth
  * Realtek Bluetooth 4.0 Adapter
* Wifi
  * Realtek RTL8723BE 802.11 bgn Wi-Fi Adapter
* Ethernet
  * Realtek RTL8139/810x Fast Ethernet Adapter
* Card Reader
  * Realtek PCI-E Card Reader

## Что получилось и не получилось "оживить"

### Что работает

* Графика Intel HD Graphics 520
* Графическое ускорение Inte Quick Sync
* TurboBust
* SpeedStep
* Регулировка яркости клавишами Fn+F2 / Fn+F3, как уменьшение и увеличение яркости соответственно 
  (так же как и в Windows 10, я специально сделал их активацию только вместе с Fn)
* Регулировка звука клавишами Fn+F6 / Fn+F7 / Fn+F8, как "Без звука", уменьшение громкости и увеличение громкости соответственно
* Регулировка аудио воспроизведения клавишами Fn+F10 / Fn+F11 / Fn+F12, как включение предыдущего трека, вопроизведение или пауза, включение слудующего трека
* Регулировка подсветки клавиатуры работает с помощью Fn+F5, но яркость подсветки клавиатуры никак не регулируется и, скорее всего, ее использование не связано с другими F клавишами
* Тачпад как Apple Magic Trackpad - работают почти все жесты
* USB 3.0 и Usb 2.0 порты
* Сон
* Порт 3.5 mini Jack для наушников
* Встроенные динамики
* Стерео микрофоны
* Веб-камера
* Ethernet
* Numpad
* Отображение заряда батареи (работает не всегда корректно, часто приходится сбрасывать CMOS в ноутбуке, зажав кнопку питания на ~20 секунд)

### Что не работает

* Wifi
* Bluetooth
* Nvidia Geforce 940MX (Nvidia Optimus)
* FaceTime, iMassage, HandOff, Continuity - для того, чтобы заставить работать эти функции нужно, чтобы работал Wifi (и, наверное, bluetooth, но это не точно), а чтобы в моем ноутбуке работал Wifi (и Bluetooth), нужно купить совместимые с macOS Mojave Wifi модули и заменить их в ноутбуке, но я не захотел этим заниматься

### Что не проверено

* Card Reader
* HDMI
* Дисковод (он распознается в macOS и его можно даже открыть нажав пару кнопок в интерфейсе, но у меня нет DVD/CD дисков, чтобы проверить работу дисковода)

## Предустановочная подготовка

MacOSX может быть установлена на диск (без форматирования) только с разметкой GPT (GUID Partition Table).

Рекомендуется во время установки MacOSX стереть (отформатировать) весь диск, но это не обязательно.

Если у вас только 1 диск (1 HDD или 1 SSD), на котором уже установлена Windows и вы хотите установить MacOSX рядом с Windows, то есть несколько вариантов решения:

* Во время установки MacOSX стереть (отформатировать) весь диск, но тогда будут удалены все файлы
* Купить отдельный диск и установить MacOSX на него
* Если ваш диск размечен в GPT, то можно в Windows отделить раздел и потом на него установить MacOSX
  * Узнать как размечен можно в Windows, для этого откройте "Управление дисками" (нажмите ПКМ по пуску), потом откройте свойства диска (нажмите ПКМ по самому диску, а не по разделам, там где написано "Диск 0" или "Диск 1"), откройте вкладку "Тома" и там посмотрите стиль раздела. Если стиль раздела "Таблица с GUID разделов", то все хорошо
  * Отделить или создать раздел в WIndows можно в той же программе "Управление дисками", для этого нажимаете ПКМ по разделу, от которого будете отделять другой раздел и в конектном меню нажимаете "Сжать" и дальше выбираете до скольки мегабайт сжать выбранный раздел. Соответственно все, что больше этих мегабайт сформируется в новую неразмеченную облать, которую вы можете разметить в любую файловую систему, но лучше в FAT32. Потом во время установки MacOSX нужно в Дисковой утилите выбрать этот раздел, отформатировать в APFA или HFS+ (зависит от версии MacOSX, которую вы устанавливаете) и при установке MacOSX выбирать этот раздел
* Если ваш диск размечен в MBR, то вам нужно будет его конвертировать в GPT, либо стереть (отформатировать) в Дисковой утилите во время установки MacOSX
  * Узнать как размечен можно в Windows, для этого откройте "Управление дисками" (нажмите ПКМ по пуску), потом откройте свойства диска (нажмите ПКМ по самому диску, а не по разделам, там где написано "Диск 0" или "Диск 1"), откройте вкладку "Тома" и там посмотрите стиль раздела. Если стиль раздела "MBR", то это плохо
  * Чтобы конвертировать MBR в GPT в Windows без потери данных нужно воспользоваться сторонними программами. Насколько мне известно, конвертировать разметку из MBR в GPT без потери данных позволяют эти программы "Paragon Hard Disk Manager", "AOMEI Partition Assistant" и "MiniTool Partition Wizard" и, возможно, какие-нибудь еще утилиты. К сожалению, только платные версии этих программ позволяют произвести конвертацию. Лично я воспользовался "MiniTool Partition Wizard" и все конвертировалось без потери данных. Так же после выключения нужно в настройках BIOS/UEFI переключить режим загрузки с CSM (Legacy) на UEFI.

## Настройка BIOS / UEFI

Эти параметры очень важны

* Сбросить к заводским настройкам
* Включить UEFI режим
* Включить AHCI
* Отключить Secure Boot
* Установить VideoRAM в 64 МБ


## Создание загрузочной флешки

1. [Скачиваем BootDiskUtility](http://cvad-mac.narod.ru/index/bootdiskutility_exe/0-5)

2. Скачиваем [специальный образ](https://applelife.ru/threads/bdu-macos-i-clover-iz-windows-izgotovlenie-zagruzochnoj-flehshki.37189/page-57#post-557498) macOS Mojave 10.14.5 для BDU (это файл с расширением .hfs, возможно он будет находится в архиве)

3. Вставляем флешку размером 8 ГБ или больше (в любой порт)

4. В BDU

   * Открываем Options -> Configuration

   * Нажимаем "Check Now" и ждем пока не обновится строка рядом

   * Все остальное оставляем поумолчанию

   * Нажимаем "Ок"

   * Выбираем флешку и нажимаем кнопку "Format" и подтверждаем действие

     > Когда флешка отформатируется на ней создадутся 2 раздела: ESP и пустой раздел. На ESP уже будет загрузчик Clover, распакованный из ISO образа из репозитория на Sourceforge

   * Выбираем второй раздел (возможно надо будет нажать на "+" слева от флешки), обычно он находится в самом низу

   * Нажимаем кнопку "Restore" и выбираем файлы 5.hfs

   * Ждем когда полоса прогресса записи образа в BDU дойдет до конца

   * Готово

## Настройка загрузочной флешки

После создания флешки с загрузчиком Clover и самой системой MacOSX, нужно настроить флешку, а точнее загрузчик, потому что просто так MacOSX на компьютер не от Apple не установится из-за отсутствия некоторых различий в оборудовании между Apple компьютерами и обычными ПК или ноутбуками.

### Используемые драйвера

[Список драйверов](/Configuring/InstalledDrivers.md)

### Настройка файла config.plist

[Инструкция по настройке конфига](/Configuring/CustomizingConfig.md)

### Используемые кексты

[Инструкция по использованию кекстов](/Configuring/InstalledKexts.md)

## Установка macOS Mojave 10.14.5

1. Стандартная установка macOS
2. Разбить диск на разделы сейчас или потом ?????

// TODO

Рекомендуется во время установки MacOSX стереть (отформатировать) диск и создать разделы в Дисковой утилите (можно и в терминале, но это сложнее). Разделить диск на разделы можно и после установки MacOSX в Дисковой утилите.

Если у вас только 1 диск (1 HDD или 1 SSD) и вы хотите установить рядом с MacOSX еще и Windows, то надо будет отделить как минимум 1 раздел (для Windows) и, желательно, второй раздел с файловой системой ExFat для файлов. Подробнее я об этом написал в инструкции по установке Windows.

## Настройка macOS

Ниже представлены самые важные, на мой взгляд, пункты, которые нужно включить на большинстве хакинтошей.

1. В терминале вводим `sudo spctl --master-disable`, чтобы отключить Gatekeeper и устанавливать приложениея не только из MacAppstore
2. Включить TRIM для SSD дисков с помощью команды в терминале `sudo trimforce enable`
3. Перекинуть файл `MyKeyboardBundle.bundle` в `/Library/Keyboard Layouts` и в `/System/Library/Keyboard Layouts` или сделать этот файл с помощью программы Ukelele и [гайда](https://www.youtube.com/watch?v=Ll6UGWGSSv8). Потом перейти в "Системные настройки", "Клавиатура", "Источники ввода" и добавить новую раскладку и удалить Русскую раскладку.

Полный список настроек, который я применяю, описан в соответствующем файле [**Настройка MacOSX**](/Configuring/ConfiguringMacOSX.md)

## Настройка Hackintosh

### Настройка сна

После установки hackintosh у меня некорректно работал сон. Если я закрывал крышку ноутбука или принудительно включал сон нажав на яблоко в углу, то ноутбук сразу уходил в сон и через несколько секунд включался.

Исправить это мне помогло выполнение этой команды в терминале и, конечно же, перезагрузка после выполнения:

`sudo pmset -a hibernatemode 0`

И добавление аргумента `darkwake=0` в аргументы загрузки системы. Честно говоря я не проверял как будет вести себя сон на ноутбуке без этого аргумента.

Подробнее про подобную настройку сна или гибернации можно почитать по этим ссылкам:

* https://bulkin.me/notes/2233
* http://osxh.ru/terminal/command/pmset
* https://www.insanelymac.com/forum/topic/299721-sleep-hibernation-how-it-works-and-how-to-use/

```xml
<key>Boot</key>
<dict>
  <key>HibernationFixup</key>
  <true/>
</dict>
```

Так же [vit9696 рекомендует](https://www.insanelymac.com/forum/topic/304530-clover-change-explanations/?do=findComment&comment=2617018) всегда включать флаг `RtcHibernateAware`, но у меня все нормально работает и с выключенным пунктом. Есть так же еще разные параметры в конфиге, позволяющие настроить гибернцаию/сон, вы можете узнать о них в бесплатной книге-учебнике Clover цвета хаки.

### Установка Windows

[Описание нюансов установки Windows рядом с Hackintosh](/AboutWindows/InstallWindows.md)

### Настройка Windows

В качестве настройки Windows 10 для работы вместе с macOS мне понадобилось настроить синхронизацию времени и для удобства сделать раздел под файлы с файловой системой ExFat. Про ExFat раздел под файлы я писал выше в инструкции по установке Windows.

Про синхронизацию времени можно почитать и найти прямые руководства там:

* https://appstudio.org/faq/3068.html
* https://www.tonymacx86.com/threads/fix-incorrect-time-in-windows-osx-dual-boot.133719/

## Настройка DSDT

// TODO

## Установка программ

### Программы первой необходимости

Если у вас hackintosh, а не настоящий Apple компьютер, то рекомендую, чтобы эти программы всегда были установлены в вашей системе. Эти программы входят в состав программ из списка Hackintosh Tools, но они являются наиболее необходимыми.

1. Clover Bootloader https://sourceforge.net/projects/cloverefiboot/
2. CloverConfigurator https://mackie100projects.altervista.org/download-clover-configurator/
3. Plist Edit Pro https://www.fatcatsoftware.com/plisteditpro/

### Hackintosh программы

Эти программы программы используются в основном для настройки Hackintosh, как рабочий инструмент macOS они вам вряд ли пригодятся. Часть этих программ желательно оставить в вашем hackintosh на тот случай, если что-то пойдет не так и система начнет "выпендриваться", ведь не все могут определить насколько правильно и насколько полноценно настроен ваш hackintosh.

[Hackintosh tools](/ProgramsList/HackintoshTools.md)

### Программы-фреймворки для работы других программ

Эти программы нужны для работы других программ или скриптов. В основном это используется разными разработчиками. Если они вам понадобятся, то вы и без этого списка будете знать, какая программа вам нужны.

[Other Software](/ProgramsList/OtherSoftware.md)

### Устанавливаемое ПО

Большинство прогамм из этого списка я использую в повседневной работе. Естественно, список не самый полный, смотрите и решайте по своим потребностям.

[Regular Software](/ProgramsList/RegularSoftware.md)